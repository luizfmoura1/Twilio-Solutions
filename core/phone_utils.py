# US Area Code to State mapping
AREA_CODE_TO_STATE = {
    # Alabama
    '205': 'AL', '251': 'AL', '256': 'AL', '334': 'AL', '938': 'AL',
    # Alaska
    '907': 'AK',
    # Arizona
    '480': 'AZ', '520': 'AZ', '602': 'AZ', '623': 'AZ', '928': 'AZ',
    # Arkansas
    '479': 'AR', '501': 'AR', '870': 'AR',
    # California
    '209': 'CA', '213': 'CA', '279': 'CA', '310': 'CA', '323': 'CA', '341': 'CA',
    '408': 'CA', '415': 'CA', '424': 'CA', '442': 'CA', '510': 'CA', '530': 'CA',
    '559': 'CA', '562': 'CA', '619': 'CA', '626': 'CA', '628': 'CA', '650': 'CA',
    '657': 'CA', '661': 'CA', '669': 'CA', '707': 'CA', '714': 'CA', '747': 'CA',
    '760': 'CA', '805': 'CA', '818': 'CA', '820': 'CA', '831': 'CA', '840': 'CA',
    '858': 'CA', '909': 'CA', '916': 'CA', '925': 'CA', '949': 'CA', '951': 'CA',
    # Colorado
    '303': 'CO', '719': 'CO', '720': 'CO', '970': 'CO',
    # Connecticut
    '203': 'CT', '475': 'CT', '860': 'CT', '959': 'CT',
    # Delaware
    '302': 'DE',
    # Florida
    '239': 'FL', '305': 'FL', '321': 'FL', '352': 'FL', '386': 'FL', '407': 'FL',
    '561': 'FL', '727': 'FL', '754': 'FL', '772': 'FL', '786': 'FL', '813': 'FL',
    '850': 'FL', '863': 'FL', '904': 'FL', '941': 'FL', '954': 'FL',
    # Georgia
    '229': 'GA', '404': 'GA', '470': 'GA', '478': 'GA', '678': 'GA', '706': 'GA',
    '762': 'GA', '770': 'GA', '912': 'GA', '943': 'GA',
    # Hawaii
    '808': 'HI',
    # Idaho
    '208': 'ID', '986': 'ID',
    # Illinois
    '217': 'IL', '224': 'IL', '309': 'IL', '312': 'IL', '331': 'IL', '618': 'IL',
    '630': 'IL', '708': 'IL', '773': 'IL', '779': 'IL', '815': 'IL', '847': 'IL', '872': 'IL',
    # Indiana
    '219': 'IN', '260': 'IN', '317': 'IN', '463': 'IN', '574': 'IN', '765': 'IN', '812': 'IN', '930': 'IN',
    # Iowa
    '319': 'IA', '515': 'IA', '563': 'IA', '641': 'IA', '712': 'IA',
    # Kansas
    '316': 'KS', '620': 'KS', '785': 'KS', '913': 'KS',
    # Kentucky
    '270': 'KY', '364': 'KY', '502': 'KY', '606': 'KY', '859': 'KY',
    # Louisiana
    '225': 'LA', '318': 'LA', '337': 'LA', '504': 'LA', '985': 'LA',
    # Maine
    '207': 'ME',
    # Maryland
    '227': 'MD', '240': 'MD', '301': 'MD', '410': 'MD', '443': 'MD', '667': 'MD',
    # Massachusetts
    '339': 'MA', '351': 'MA', '413': 'MA', '508': 'MA', '617': 'MA', '774': 'MA', '781': 'MA', '857': 'MA', '978': 'MA',
    # Michigan
    '231': 'MI', '248': 'MI', '269': 'MI', '313': 'MI', '517': 'MI', '586': 'MI',
    '616': 'MI', '734': 'MI', '810': 'MI', '906': 'MI', '947': 'MI', '989': 'MI',
    # Minnesota
    '218': 'MN', '320': 'MN', '507': 'MN', '612': 'MN', '651': 'MN', '763': 'MN', '952': 'MN',
    # Mississippi
    '228': 'MS', '601': 'MS', '662': 'MS', '769': 'MS',
    # Missouri
    '314': 'MO', '417': 'MO', '573': 'MO', '636': 'MO', '660': 'MO', '816': 'MO',
    # Montana
    '406': 'MT',
    # Nebraska
    '308': 'NE', '402': 'NE', '531': 'NE',
    # Nevada
    '702': 'NV', '725': 'NV', '775': 'NV',
    # New Hampshire
    '603': 'NH',
    # New Jersey
    '201': 'NJ', '551': 'NJ', '609': 'NJ', '640': 'NJ', '732': 'NJ', '848': 'NJ', '856': 'NJ', '862': 'NJ', '908': 'NJ', '973': 'NJ',
    # New Mexico
    '505': 'NM', '575': 'NM',
    # New York
    '212': 'NY', '315': 'NY', '332': 'NY', '347': 'NY', '516': 'NY', '518': 'NY',
    '585': 'NY', '607': 'NY', '631': 'NY', '646': 'NY', '680': 'NY', '716': 'NY',
    '718': 'NY', '838': 'NY', '845': 'NY', '914': 'NY', '917': 'NY', '929': 'NY', '934': 'NY',
    # North Carolina
    '252': 'NC', '336': 'NC', '704': 'NC', '743': 'NC', '828': 'NC', '910': 'NC', '919': 'NC', '980': 'NC', '984': 'NC',
    # North Dakota
    '701': 'ND',
    # Ohio
    '216': 'OH', '220': 'OH', '234': 'OH', '283': 'OH', '326': 'OH', '330': 'OH',
    '380': 'OH', '419': 'OH', '440': 'OH', '513': 'OH', '567': 'OH', '614': 'OH', '740': 'OH', '937': 'OH',
    # Oklahoma
    '405': 'OK', '539': 'OK', '580': 'OK', '918': 'OK',
    # Oregon
    '458': 'OR', '503': 'OR', '541': 'OR', '971': 'OR',
    # Pennsylvania
    '215': 'PA', '223': 'PA', '267': 'PA', '272': 'PA', '412': 'PA', '445': 'PA',
    '484': 'PA', '570': 'PA', '582': 'PA', '610': 'PA', '717': 'PA', '724': 'PA', '814': 'PA', '835': 'PA', '878': 'PA',
    # Rhode Island
    '401': 'RI',
    # South Carolina
    '803': 'SC', '839': 'SC', '843': 'SC', '854': 'SC', '864': 'SC',
    # South Dakota
    '605': 'SD',
    # Tennessee
    '423': 'TN', '615': 'TN', '629': 'TN', '731': 'TN', '865': 'TN', '901': 'TN', '931': 'TN',
    # Texas
    '210': 'TX', '214': 'TX', '254': 'TX', '281': 'TX', '325': 'TX', '346': 'TX',
    '361': 'TX', '409': 'TX', '430': 'TX', '432': 'TX', '469': 'TX', '512': 'TX',
    '682': 'TX', '713': 'TX', '726': 'TX', '737': 'TX', '806': 'TX', '817': 'TX',
    '830': 'TX', '832': 'TX', '903': 'TX', '915': 'TX', '936': 'TX', '940': 'TX',
    '956': 'TX', '972': 'TX', '979': 'TX',
    # Utah
    '385': 'UT', '435': 'UT', '801': 'UT',
    # Vermont
    '802': 'VT',
    # Virginia
    '276': 'VA', '434': 'VA', '540': 'VA', '571': 'VA', '703': 'VA', '757': 'VA', '804': 'VA', '826': 'VA', '948': 'VA',
    # Washington
    '206': 'WA', '253': 'WA', '360': 'WA', '425': 'WA', '509': 'WA', '564': 'WA',
    # Washington DC
    '202': 'DC',
    # West Virginia
    '304': 'WV', '681': 'WV',
    # Wisconsin
    '262': 'WI', '414': 'WI', '534': 'WI', '608': 'WI', '715': 'WI', '920': 'WI',
    # Wyoming
    '307': 'WY',
}


def get_state_from_phone(phone_number: str) -> str | None:
    """
    Extract US state from phone number based on area code.

    Args:
        phone_number: Phone number in any format (+1XXXXXXXXXX, 1XXXXXXXXXX, XXXXXXXXXX)

    Returns:
        Two-letter state code (e.g., 'CA', 'TX', 'NY') or None if not found
    """
    # Remove all non-digit characters
    digits = ''.join(filter(str.isdigit, phone_number))

    # Remove country code if present
    if digits.startswith('1') and len(digits) == 11:
        digits = digits[1:]

    # Extract area code (first 3 digits)
    if len(digits) >= 3:
        area_code = digits[:3]
        return AREA_CODE_TO_STATE.get(area_code)

    return None


def format_phone_number(phone_number: str) -> str:
    """
    Format phone number to E.164 format (+1XXXXXXXXXX)
    """
    digits = ''.join(filter(str.isdigit, phone_number))

    if len(digits) == 10:
        return f'+1{digits}'
    elif len(digits) == 11 and digits.startswith('1'):
        return f'+{digits}'

    return phone_number


def get_caller_id_for_number(to_number: str) -> str:
    """
    Get the appropriate Caller ID based on the destination number's state.

    - Florida leads → Florida number
    - Texas leads → Texas number
    - Other states → Toll-free number

    Args:
        to_number: Destination phone number

    Returns:
        Caller ID to use for the call
    """
    from core.config import Config

    state = get_state_from_phone(to_number)

    if state == 'FL':
        return Config.CALLER_ID_FL
    elif state == 'TX':
        return Config.CALLER_ID_TX
    else:
        return Config.CALLER_ID_DEFAULT


# US State to Timezone mapping
STATE_TO_TIMEZONE = {
    # Eastern Time (ET)
    'CT': 'America/New_York', 'DE': 'America/New_York', 'FL': 'America/New_York',
    'GA': 'America/New_York', 'IN': 'America/New_York', 'KY': 'America/New_York',
    'ME': 'America/New_York', 'MD': 'America/New_York', 'MA': 'America/New_York',
    'MI': 'America/New_York', 'NH': 'America/New_York', 'NJ': 'America/New_York',
    'NY': 'America/New_York', 'NC': 'America/New_York', 'OH': 'America/New_York',
    'PA': 'America/New_York', 'RI': 'America/New_York', 'SC': 'America/New_York',
    'VT': 'America/New_York', 'VA': 'America/New_York', 'WV': 'America/New_York',
    'DC': 'America/New_York',
    # Central Time (CT)
    'AL': 'America/Chicago', 'AR': 'America/Chicago', 'IL': 'America/Chicago',
    'IA': 'America/Chicago', 'KS': 'America/Chicago', 'LA': 'America/Chicago',
    'MN': 'America/Chicago', 'MS': 'America/Chicago', 'MO': 'America/Chicago',
    'NE': 'America/Chicago', 'ND': 'America/Chicago', 'OK': 'America/Chicago',
    'SD': 'America/Chicago', 'TN': 'America/Chicago', 'TX': 'America/Chicago',
    'WI': 'America/Chicago',
    # Mountain Time (MT)
    'AZ': 'America/Phoenix', 'CO': 'America/Denver', 'ID': 'America/Denver',
    'MT': 'America/Denver', 'NM': 'America/Denver', 'UT': 'America/Denver',
    'WY': 'America/Denver',
    # Pacific Time (PT)
    'CA': 'America/Los_Angeles', 'NV': 'America/Los_Angeles', 'OR': 'America/Los_Angeles',
    'WA': 'America/Los_Angeles',
    # Alaska Time
    'AK': 'America/Anchorage',
    # Hawaii Time
    'HI': 'Pacific/Honolulu',
}


def get_timezone_for_state(state: str) -> str:
    """
    Get timezone for a US state.

    Args:
        state: Two-letter state code

    Returns:
        Timezone string (defaults to America/New_York if not found)
    """
    return STATE_TO_TIMEZONE.get(state, 'America/New_York')


def get_contact_period(utc_datetime, state: str = None) -> str:
    """
    Determine contact period (morning, afternoon, evening) based on local time.

    Args:
        utc_datetime: DateTime in UTC
        state: Two-letter state code for timezone conversion

    Returns:
        'morning' (6-12), 'afternoon' (12-18), or 'evening' (18-6)
    """
    from datetime import datetime, timezone as tz
    try:
        import pytz
    except ImportError:
        # Fallback if pytz not available - use UTC
        hour = utc_datetime.hour if utc_datetime else 12
        if 6 <= hour < 12:
            return 'morning'
        elif 12 <= hour < 18:
            return 'afternoon'
        else:
            return 'evening'

    if not utc_datetime:
        return 'afternoon'

    # Get timezone for state
    tz_name = get_timezone_for_state(state) if state else 'America/New_York'

    try:
        local_tz = pytz.timezone(tz_name)
        # Ensure UTC datetime has timezone info
        if utc_datetime.tzinfo is None:
            utc_datetime = pytz.utc.localize(utc_datetime)
        local_time = utc_datetime.astimezone(local_tz)
        hour = local_time.hour
    except Exception:
        hour = utc_datetime.hour if utc_datetime else 12

    if 6 <= hour < 12:
        return 'morning'
    elif 12 <= hour < 18:
        return 'afternoon'
    else:
        return 'evening'


def get_lead_phone_for_call(direction: str, from_number: str, to_number: str) -> str:
    """
    Get the lead's phone number based on call direction.

    Args:
        direction: 'inbound' or 'outbound'
        from_number: From number
        to_number: To number

    Returns:
        Lead's phone number
    """
    if direction == 'inbound':
        return from_number
    else:
        return to_number
